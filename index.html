<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NUST NET Mock Test (Professional)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        body { 
            font-family: 'Verdana', sans-serif; 
            margin: 0; 
            padding: 0; 
            background-color: #fff; 
            font-size: 14px; 
            user-select: none; 
            overflow: hidden; 
        }
        
        /* --- HEADER --- */
        .top-header { 
            display: flex; 
            justify-content: space-between; 
            padding: 5px 10px; 
            border-bottom: 2px solid #ccc; 
            font-weight: bold; 
            height: 30px; 
            align-items: center; 
            flex-wrap: wrap;
        }
        .subject-name { 
            color: #008080; 
            text-decoration: underline; 
            cursor: pointer; 
            flex: 1 1 100%; 
            text-align: center;
        }
        .test-category { 
            color: #cc0000; 
            text-align: center; 
            font-size: 12px;
        }
        .center-id { 
            color: #cc0000; 
            font-size: 12px;
        }

        /* --- BLUE BARS --- */
        .blue-bar {
            background: linear-gradient(to bottom, #dcebf7 0%, #a2c6e5 100%);
            border: 1px solid #6699cc; 
            padding: 4px 10px; 
            font-weight: bold; 
            color: #000066;
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            font-size: 12px;
            flex-wrap: wrap;
        }

        /* --- MAIN LAYOUT --- */
        .main-container { 
            display: flex; 
            flex-wrap: wrap; 
            height: calc(100vh - 105px); 
            padding: 5px; 
            box-sizing: border-box; 
        }
        .content-area { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            margin-right: 5px; 
        }
        
        /* Question Area */
        .question-box { 
            border: 1px solid #999; 
            padding: 10px; 
            height: 140px; 
            overflow-y: auto; 
            margin-bottom: 5px; 
            font-family: 'Times New Roman', serif; /* Better for Math */
            font-size: 17px; 
            font-weight: 500; 
            background: #fff; 
        }

        /* Options */
        .options-container { 
            margin-top: 5px; 
            overflow-y: auto; 
            flex: 1; 
            border: 1px solid #ccc; 
            padding: 5px; 
        }
        .option-row { 
            border: 1px solid #999; 
            padding: 8px; 
            margin-bottom: 4px; 
            display: flex; 
            align-items: center; 
            background: #fff; 
            cursor: pointer; 
            font-size: 13px; 
        }
        .option-row:hover { 
            background: #eef; 
        }
        .option-row input { 
            margin-right: 10px; 
        }

        /* Photo Section */
        .photo-area { 
            width: 130px; 
            border: 2px solid #cc3333; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            background: #fff5f5; 
            text-align: center; 
            height: 150px; 
        }

        /* --- FOOTER --- */
        .footer { 
            position: fixed; 
            bottom: 0; 
            width: 100%; 
            height: 65px; 
            background: #f0f0f0; 
            border-top: 2px solid #336699; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 0 5px; 
            box-sizing: border-box; 
            flex-wrap: wrap;
        }

        /* Timer */
        .timer-box { 
            background: #009933; 
            color: white; 
            border: 2px solid #006600; 
            width: 120px; 
            height: 50px; 
            padding: 2px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            font-size: 11px; 
        }
        .timer-val { 
            font-size: 16px; 
            font-weight: bold; 
            display: flex; 
            align-items: center; 
            gap: 5px; 
        }
        .start-time { 
            background: #e0e0e0; 
            color: black; 
            padding: 1px 5px; 
            margin-bottom: 2px; 
            width: 100%; 
            text-align: center; 
        }

        /* Finish Link */
        .finish-link { 
            color: blue; 
            font-weight: bold; 
            cursor: pointer; 
            text-decoration: underline; 
            position: absolute; 
            left: 50%; 
            transform: translateX(-50%); 
            font-size: 12px; 
        }

        /* Buttons */
        .btn-group { 
            display: flex; 
            gap: 3px; 
            margin-right: 10px; 
            flex-wrap: wrap;
        }
        .nav-btn {
            width: 50px; 
            height: 45px; 
            border-radius: 3px; 
            cursor: pointer;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            font-size: 9px; 
            border: 1px solid #003366; 
            color: white;
            background: linear-gradient(to bottom, #7aa7d6 0%, #3a6da0 100%);
        }
        .nav-btn i { 
            font-size: 16px; 
            margin-bottom: 2px; 
        }
        .nav-btn:active { 
            transform: translateY(1px); 
        }

        /* Button Colors */
        .btn-grey { 
            background: linear-gradient(to bottom, #f0f0f0 0%, #d0d0d0 100%); 
            color: black; 
            border: 1px solid #999; 
        }
        .btn-yellow { 
            background: linear-gradient(to bottom, #f0ad4e 0%, #ec971f 100%); 
            border: 1px solid #d58512; 
        }

        /* Result Screen */
        #result-screen { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(255,255,255,0.95); 
            z-index: 2000; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
        }
        .result-box { 
            border: 3px solid #003366; 
            padding: 30px; 
            text-align: center; 
            background: white; 
            width: 400px; 
            box-shadow: 0 0 20px rgba(0,0,0,0.2); 
        }
        
        /* Loading Screen */
        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 3000; display: flex;
            align-items: center; justify-content: center; font-size: 20px;
            color: #003366; flex-direction: column;
        }

        /* Jump Input */
        .jump-box {
            display: flex;
            align-items: center;
            margin-right: 15px;
            font-size: 10px;
        }
        .jump-box input {
            width: 30px;
            margin: 0 5px;
            text-align: center;
        }

        /* --- RESPONSIVE DESIGN --- */
        @media (max-width: 768px) {
            .top-header { flex-direction: column; align-items: center; padding: 10px 5px; }
            .main-container { flex-direction: column; padding: 5px;}
            .content-area { margin-right: 0;}
            .photo-area { width: 100%; height: auto; margin-top: 10px;}
            .footer { flex-direction: column; height: auto; padding: 10px 5px; }
            .nav-btn { width: 45px; height: 40px; }
            .finish-link { position: static; transform: none; margin: 6px 0; text-align: center; display: block; order: 2; }
            .jump-box { display: none; } /* Hide jump on mobile to save space */
        }
        @media (max-width: 480px) {
            .question-box { height: auto; padding: 10px 5px; }
            .option-row { font-size: 12px; }
        }

    </style>
</head>
<body>

<div id="loading-screen">
    <div><i class="fas fa-spinner fa-spin"></i> Loading Test Data...</div>
    <div style="font-size: 12px; margin-top: 10px; color: #666;">Please ensure 'questions.csv' is uploaded.</div>
</div>

<div id="result-screen">
    <div class="result-box">
        <h1 style="color: #003366; margin-top: 0;">Test Summary</h1>
        <hr>
        <p>Total Questions: <b id="res-total"></b></p>
        <p>Attempted: <b id="res-attempted"></b></p>
        <p style="font-size: 20px; color: green;">Your Score: <b id="res-score"></b></p>
        <button onclick="clearSession()" style="padding: 10px 20px; background: #cc0000; color: white; border: none; cursor: pointer; margin-top: 20px;">Close & Reset</button>
    </div>
</div>

<div class="top-header">
    <div class="subject-name" id="subject-header">Mathematics (Engineering)</div>
    <div class="test-category">NET Simulation Exam</div>
    <div class="center-id">NUST-ISB (Center-1)</div>
</div>

<div class="main-container">
    <div class="content-area">
        <div class="blue-bar">
            <span>Question No: <span id="q-curr">1</span> of <span id="q-total">20</span></span>
            <span>Marks: 1 &nbsp; <input type="checkbox" checked disabled> Photograph</span>
        </div>

        <div class="question-box">
            <strong style="text-decoration: underline;">Question:</strong>
            <br>
            <span id="q-text">Loading...</span>
        </div>

        <div class="blue-bar" style="margin-top: 5px;">
            <span>Answer (Please select your correct option)</span>
            <span id="save-status" style="font-size: 10px; padding: 2px 5px; background: #ccc; border-radius: 3px;">Not Saved</span>
        </div>

        <div class="options-container" id="options-box">
        </div>
    </div>

    <div class="photo-area">
        <i class="fas fa-user" style="font-size: 60px; color: #ccc;"></i>
        <br><b>Candidate<br>Image</b>
    </div>
</div>

<div class="footer">
    <div class="timer-box">
        <div class="start-time" id="start-display">--:--</div>
        <div class="timer-val">
            <span id="timer-display">180:00</span> <i class="far fa-clock" style="font-size: 14px;"></i>
        </div>
        <div style="font-size: 9px;">HH : MM : SS</div>
    </div>

    <div class="finish-link" onclick="finishTest()">Click here to FINISH Your Test</div>

    <div class="btn-group">
        <div class="jump-box">
            Go to: <input type="number" id="jump-input" min="1" max="200">
            <button onclick="jumpToInput()" style="cursor:pointer;">Go</button>
        </div>

        <button class="nav-btn btn-grey" onclick="saveData()"><i class="fas fa-save"></i> Save</button>
        <button class="nav-btn" onclick="moveNext()"><i class="fas fa-caret-right"></i> Next</button>
        <button class="nav-btn" onclick="movePrev()"><i class="fas fa-caret-left"></i> Prev</button>
        <button class="nav-btn btn-grey" onclick="markReview()"><i class="fas fa-file-alt"></i> Review</button>
        
        <div style="width: 15px;"></div> 
        <button class="nav-btn" onclick="changeSection(1)"><i class="fas fa-share"></i> Next<br>Sec</button>
        <button class="nav-btn" onclick="changeSection(-1)"><i class="fas fa-reply"></i> Prev<br>Sec</button>
        
        <button class="nav-btn btn-grey" onclick="jumpTo(0)"><i class="fas fa-step-backward"></i> First</button>
        <button class="nav-btn btn-grey" onclick="jumpTo('last')"><i class="fas fa-step-forward"></i> Last</button>
        <button class="nav-btn btn-yellow" onclick="alert('Help: Select an option and click Save.')"><i class="fas fa-question-circle"></i> Help</button>
    </div>
</div>

<script>
    // --- GLOBAL VARIABLES ---
    let allQuestions = [];
    let activeQuestions = [];
    const subjectList = ["Mathematics", "Physics", "English"];
    let currentSubjectIndex = 0;
    let currIdx = 0;
    
    // Load Saved State
    let userResp = JSON.parse(localStorage.getItem('nust_resp')) || {}; 
    let reviewList = JSON.parse(localStorage.getItem('nust_rev')) || {};

    // --- 1. PROFESSIONAL CSV PARSING FUNCTION ---
    function parseCSVLine(str) {
        const result = [];
        let cell = '';
        let quote = false;
        for (let i = 0; i < str.length; i++) {
            let char = str[i];
            if (char === '"' && str[i+1] === '"') { cell += '"'; i++; } 
            else if (char === '"') { quote = !quote; }
            else if (char === ',' && !quote) { result.push(cell); cell = ''; }
            else { cell += char; }
        }
        result.push(cell);
        return result;
    }

    // --- 2. FETCH DATA FROM FILE ---
    async function loadQuestionsFromFile() {
        try {
            const response = await fetch('questions.csv');
            
            if(!response.ok) {
                throw new Error("CSV File not found. Make sure 'questions.csv' exists.");
            }

            const data = await response.text();
            
            const rows = data.split('\n');
            const parsedQuestions = [];

            // Skip Header Row (i=1)
            for (let i = 1; i < rows.length; i++) {
                const rowRaw = rows[i].trim();
                if(rowRaw.length === 0) continue;

                const cols = parseCSVLine(rowRaw);
                
                if(cols.length < 7) continue;

                const srNo = parseInt(cols[0]);
                
                // --- FIXED LOGIC FOR SUBJECTS (1-100 Math, 101-160 Phy, 161+ Eng) ---
                let subject = "English";
                if (srNo >= 1 && srNo <= 100) subject = "Mathematics";
                else if (srNo >= 101 && srNo <= 160) subject = "Physics";
                else if (srNo >= 161) subject = "English";

                // Answer Detection
                let ansIndex = -1;
                const correctText = cols[6].trim().toLowerCase();
                
                if (correctText.startsWith("a") || correctText === cols[2].trim().toLowerCase()) ansIndex = 0;
                else if (correctText.startsWith("b") || correctText === cols[3].trim().toLowerCase()) ansIndex = 1;
                else if (correctText.startsWith("c") || correctText === cols[4].trim().toLowerCase()) ansIndex = 2;
                else if (correctText.startsWith("d") || correctText === cols[5].trim().toLowerCase()) ansIndex = 3;

                if (ansIndex === -1) ansIndex = 0;

                parsedQuestions.push({
                    id: srNo, 
                    sub: subject,
                    q: cols[1], 
                    o: [cols[2], cols[3], cols[4], cols[5]], 
                    a: ansIndex
                });
            }

            allQuestions = parsedQuestions;
            
            document.getElementById('loading-screen').style.display = 'none';
            
            loadSection(subjectList[0]);
            startTimer();

        } catch (error) {
            document.getElementById('loading-screen').innerHTML = `
                <div style="color:red; text-align:center;">
                    Error Loading File!<br>
                    <small>${error.message}</small><br>
                    <small>Please upload <b>questions.csv</b> to your GitHub repository.</small>
                </div>`;
        }
    }

    // --- 3. SECTIONS & NAVIGATION ---
    
    function loadSection(subjectName) {
        activeQuestions = allQuestions.filter(q => q.sub === subjectName);
        document.getElementById('subject-header').innerText = subjectName + " (Engineering)";
        if(currIdx >= activeQuestions.length) currIdx = 0;
        renderQ();
    }

    function changeSection(dir) {
        currentSubjectIndex += dir;
        if (currentSubjectIndex < 0) currentSubjectIndex = 0;
        if (currentSubjectIndex >= subjectList.length) currentSubjectIndex = subjectList.length - 1;
        currIdx = 0; 
        loadSection(subjectList[currentSubjectIndex]);
    }

    // --- 4. RENDER QUESTION ---
    function renderQ() {
        if(activeQuestions.length === 0) {
            document.getElementById('q-text').innerText = "No questions found in this section.";
            return;
        }

        const qData = activeQuestions[currIdx];
        const globalId = qData.id;

        document.getElementById('q-curr').innerText = currIdx + 1;
        document.getElementById('q-total').innerText = activeQuestions.length;
        
        document.getElementById('q-text').innerHTML = qData.q;

        const statusEl = document.getElementById('save-status');
        if(userResp[globalId] !== undefined) {
            statusEl.innerText = "Saved";
            statusEl.style.background = "#5cb85c"; 
            statusEl.style.color = "white";
        } else if (reviewList[globalId]) {
            statusEl.innerText = "Review";
            statusEl.style.background = "#f0ad4e"; 
            statusEl.style.color = "white";
        } else {
            statusEl.innerText = "Not Answered";
            statusEl.style.background = "#d9534f"; 
            statusEl.style.color = "white";
        }

        const container = document.getElementById('options-box');
        container.innerHTML = "";
        
        qData.o.forEach((opt, i) => {
            const isChecked = (userResp[globalId] === i) ? "checked" : "";
            const rowColor = (isChecked) ? "#e6ffe6" : "#fff";
            
            container.innerHTML += `
                <label class="option-row" style="background:${rowColor}" onclick="highlightRow(this)">
                    <input type="radio" name="ans" value="${i}" ${isChecked}>
                    <span>${opt}</span>
                </label>
            `;
        });

        if(window.MathJax) {
            MathJax.typesetPromise([document.getElementById('q-text'), container])
                .catch((err) => console.log('MathJax error:', err));
        }
    }

    window.highlightRow = function(el) {
        document.querySelectorAll('.option-row').forEach(d => d.style.background = "#fff");
        el.style.background = "#e6ffe6";
        el.querySelector('input').checked = true;
    }

    // --- 5. BUTTON ACTIONS ---
    function saveData() {
        const selected = document.querySelector('input[name="ans"]:checked');
        if(selected) {
            const globalId = activeQuestions[currIdx].id;
            userResp[globalId] = parseInt(selected.value);
            localStorage.setItem('nust_resp', JSON.stringify(userResp));
            const statusEl = document.getElementById('save-status');
            statusEl.innerText = "Saved";
            statusEl.style.background = "#5cb85c"; 
            statusEl.style.color = "white";
        }
    }

    function moveNext() {
        if(currIdx < activeQuestions.length - 1) {
            currIdx++;
            renderQ();
        } else {
            alert("End of section. Click 'Next Sec' or check Review.");
        }
    }

    function movePrev() {
        if(currIdx > 0) {
            currIdx--;
            renderQ();
        }
    }

    function jumpTo(target) {
        if (target === 'last') currIdx = activeQuestions.length - 1;
        else currIdx = target;
        renderQ();
    }

    function markReview() {
        const globalId = activeQuestions[currIdx].id;
        reviewList[globalId] = true;
        localStorage.setItem('nust_rev', JSON.stringify(reviewList));
        renderQ(); 
    }

    // New Function: Jump to Specific Question ID
    function jumpToInput() {
        const val = parseInt(document.getElementById('jump-input').value);
        if(!val) return;

        // Find which subject this ID belongs to
        let targetSub = "";
        if(val >= 1 && val <= 100) targetSub = "Mathematics";
        else if(val >= 101 && val <= 160) targetSub = "Physics";
        else if(val >= 161) targetSub = "English";
        else { alert("Question ID out of range"); return; }

        // Switch Subject
        currentSubjectIndex = subjectList.indexOf(targetSub);
        loadSection(targetSub);

        // Find index in active array
        const foundIdx = activeQuestions.findIndex(q => q.id === val);
        if(foundIdx !== -1) {
            currIdx = foundIdx;
            renderQ();
        }
    }

    // New Function: Keyboard Shortcuts
    document.addEventListener('keydown', function(event) {
        if(event.key === "ArrowRight") moveNext();
        if(event.key === "ArrowLeft") movePrev();
        if(event.key === "Enter") saveData();
    });

    function finishTest(force = false) {
        if(!force && !confirm("Are you sure you want to FINISH?")) return;
        let score = 0;
        let attempted = Object.keys(userResp).length;
        allQuestions.forEach(q => {
            if(userResp[q.id] === q.a) score++;
        });
        document.getElementById('res-total').innerText = allQuestions.length;
        document.getElementById('res-attempted').innerText = attempted;
        document.getElementById('res-score').innerText = score;
        document.getElementById('result-screen').style.display = 'flex';
    }

    function clearSession() {
        localStorage.removeItem('nust_target_time');
        localStorage.removeItem('nust_start_txt');
        localStorage.removeItem('nust_resp');
        localStorage.removeItem('nust_rev');
        location.reload();
    }

    // --- 6. TIMER (FIXED: Shows HH:MM:SS) ---
    function startTimer() {
        const DURATION_MINS = 180; // 3 Hours
        let targetTime = localStorage.getItem('nust_target_time');
        let startTimeTxt = localStorage.getItem('nust_start_txt');

        if (!targetTime) {
            const now = new Date();
            targetTime = now.getTime() + (DURATION_MINS * 60 * 1000);
            localStorage.setItem('nust_target_time', targetTime);
            startTimeTxt = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            localStorage.setItem('nust_start_txt', startTimeTxt);
        }
        document.getElementById('start-display').innerText = "Start: " + startTimeTxt;

        setInterval(() => {
            const now = new Date().getTime();
            const diff = targetTime - now;
            
            if (diff <= 0) {
                document.getElementById('timer-display').innerText = "00:00:00";
                finishTest(true); 
                return;
            }

            // Calculate hours, minutes, seconds
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            // Formatting to 00:00:00
            const displayStr = 
                (hours < 10 ? "0" + hours : hours) + ":" + 
                (minutes < 10 ? "0" + minutes : minutes) + ":" + 
                (seconds < 10 ? "0" + seconds : seconds);

            document.getElementById('timer-display').innerText = displayStr;
            
            // Visual Warning for last 10 mins
            if(diff < 10 * 60 * 1000) {
                document.querySelector('.timer-box').style.background = "#cc0000";
            }
        }, 1000);
    }

    // --- INITIALIZE ---
    loadQuestionsFromFile();

</script>
</body>
</html>
